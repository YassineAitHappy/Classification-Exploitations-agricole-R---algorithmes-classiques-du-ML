# Adresse du dossier où vous travaillez
setwd("./AnalyseDeDonnes/Data/Data")

# Packages utilisés dans la suite
library(ROCR)
library(pROC)
library(caret)
# Supprimer toutes les variables
rm(list=ls(all=TRUE))
# Supprimer tous les graphiques déjà présents
graphics.off()

# Charger les données d'entraînement
load("./AnalyseDeDonnes/Data/Data/Projets/farm_data_train.rda")
ls()
head(data_train)

# Diviser les données en ensembles d'entraînement et de test
set.seed(9)  # Pour rendre la division reproductible
index <- createDataPartition(data_train$DIFF, p = 0.95,list = FALSE)

# 90% des données pour l'entraînemen
data_training <- data_train[index, ]
data_training <- data.frame(x1 = data_training$R2, x2 = data_training$R14, x3 = data_training$R17, x4 = data_training$R32 , DIFF= data_training$DIFF)

# 10% des données pour les tests
data_testing <- data_train[-index, ]

# Séparation des données et de la sortie pour l'ensemble d'entraînement
data_training_x <- data.frame(x1 = data_training$R2, x2 = data_training$R14, x3 = data_training$R17, x4 = data_training$R32)
data_training_y <- as.factor(data_training$DIFF)

# Régression logistique
glm_train <- glm(DIFF~. , data = data_training, family=binomial())


# Séparation des données et de la sortie pour l'ensemble de test
data_testing_x <- data.frame(x1 = data_testing$R2, x2 = data_testing$R14, x3 = data_testing$R17, x4 = data_testing$R32)

# Prédiction sur les données test
glm_train_predict <- predict(glm_train, newdata=data_testing_x, type="response")
result_glm_train_predict <- (glm_train_predict > 0.3)

# Comparaison des valeurs prédites et des valeurs observées
table(result_glm_train_predict, data_testing$DIFF)
# Calcul du taux d’erreur
glm_error_rate <- mean(result_glm_train_predict != data_testing$DIFF)
cat("error rate using test data (Logistic regression) = ", glm_error_rate)

# Prédiction des probabilités au lieu des classes
probas_glm_train <- predict(glm_train, newdata = data_testing_x, type = "response")

# Création d'un objet de performance ROC
roc_obj_glm_train <- roc(data_testing$DIFF, probas_glm_train)

# Tracé de la courbe ROC
plot(roc_obj_glm_train, col = "blue", main = "Courbe ROC - Régression Logistique")

# Aire sous la courbe
AUC <- auc(roc_obj_glm_train)
cat("AUC = ", AUC)

# Choix du seuil
result <- NULL
threshold <- seq(0,1,len=11)
for (s in threshold)
{
  test <- as.integer(probas_glm_train >= s)
  result <- c(result,1-mean(test != data_testing$DIFF))
  print(result)
}
plot(threshold,result,type="l")
cat("Meilleur seuil ", threshold[which.max(result)])

# Charger les données de test fournies par la professeure (vous devez avoir un fichier ou une manière de charger ces données)

# Remplacez 'INSERT_PATH_TO_TEST_DATA' par le chemin vers votre fichier de données de test
load("./Data/Data/Projets/farm_data_test.rda")

# Sélectionner les colonnes nécessaires pour les prédictions (x1, x2, x3, x4)
data_test_x <- data.frame(x1 = data_test$R2, x2 = data_test$R14, x3 = data_test$R17, x4 = data_test$R32)

# Faire des prédictions
predictions_test <- predict(glm_train, newdata = data_test_x, type = "response")
result_predict <- (predictions_test > 0.3)
# Conversion du vecteur de TRUE/FALSE en vecteur de 0 et 1
result_predict_numeric <- as.numeric(result_predict)

# Création d'un data frame avec les prédictions numériques
results_predictions <- data.frame(DIFF_predicted=result_predict_numeric) 
results_predictions <- cbind(data_test, results_predictions)
# Sauvegarder les prédictions dans un fichier .rda
save(results_predictions, file = "./Data/Data/Projets/results_predictions.rda")

